// Generated by CoffeeScript 1.10.0
(function() {
  var _, breq;

  breq = require('bluereq');

  _ = require('./utils');

  module.exports = function(config) {
    var getLoginToken, login, loginUrl, parseLoginToken, password, reallyLogin, username;
    username = config.username, password = config.password;
    loginUrl = "https://www.wikidata.org/w/api.php?action=login&lgname=" + username + "&lgpassword=" + password + "&format=json";
    login = function() {
      return getLoginToken().then(reallyLogin)["catch"](_.Error('login'));
    };
    getLoginToken = function() {
      return breq.post(loginUrl).then(parseLoginToken);
    };
    parseLoginToken = function(res) {
      var data, loginCookies;
      loginCookies = _.extractCookies(res);
      return data = {
        token: encodeURIComponent(res.body.login.token),
        cookies: loginCookies
      };
    };
    reallyLogin = function(data) {
      var cookies, loginUrlWithToken, token;
      cookies = data.cookies, token = data.token;
      loginUrlWithToken = loginUrl + "&lgtoken=" + token;
      return breq.post(_.requestParams(loginUrlWithToken, cookies)).then(_.extractCookies);
    };
    return login();
  };

}).call(this);
