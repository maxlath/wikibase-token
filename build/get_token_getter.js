// Generated by CoffeeScript 1.9.3
(function() {
  var _, breq, getToken, parseTokens;

  breq = require('bluereq');

  _ = require('./utils');

  getToken = function(loginCookies) {
    var url;
    url = "https://www.wikidata.org/w/api.php?action=query&meta=tokens&format=json";
    return breq.get(_.requestParams(url, loginCookies)).then(parseTokens.bind(null, loginCookies));
  };

  parseTokens = function(loginCookies, res) {
    var data, fullCookies, newCookies;
    newCookies = _.extractCookies(res);
    fullCookies = loginCookies + ';\n' + newCookies;
    return data = {
      token: res.body.query.tokens.csrftoken,
      cookie: fullCookies
    };
  };

  module.exports = function(loginCookiesPromise) {
    var tokenGetter;
    return tokenGetter = function() {
      return loginCookiesPromise.then(getToken)["catch"](_.Error('getToken'));
    };
  };

}).call(this);
